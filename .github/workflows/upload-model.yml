name: Upload ML Model to S3

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  upload:
    runs-on: ubuntu-latest
    env:
      BACKEND_HOST: 0.0.0.0
      BACKEND_PORT: 10000         # matches backend/main.py default PORT
      HEALTH_PATH: /health        # your main provides /health
      START_TIMEOUT: 30           # seconds to wait for health endpoint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::601559288497:role/GitHubActionsTerraformRole
          aws-region: us-east-2

      - name: Debug AWS Identity
        run: |
          echo "Checking assumed role..."
          aws sts get-caller-identity

      - name: Upload model to S3
        run: |
          aws s3 cp backend/models/ s3://icu-model/models/ --recursive || echo "s3 upload returned non-zero (check path / permissions)"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Start backend (uvicorn) in background and capture logs
        run: |
          echo "Starting backend (uvicorn backend.main:app) on ${BACKEND_HOST}:${BACKEND_PORT}..."
          : > backend.log

          # Start uvicorn; if not installed, fallback to running the script directly.
          if python -c "import importlib.util,sys; sys.exit(0 if importlib.util.find_spec('uvicorn') else 1)"; then
            echo "uvicorn available -> starting via python -m uvicorn backend.main:app"
            nohup python -m uvicorn backend.main:app --host ${BACKEND_HOST} --port ${BACKEND_PORT} --workers 1 > backend.log 2>&1 & echo $! > backend.pid
          else
            echo "uvicorn not found -> running backend/main.py directly (script uses uvicorn.run inside it)"
            nohup python backend/main.py > backend.log 2>&1 & echo $! > backend.pid
          fi

          echo "Waiting up to ${START_TIMEOUT}s for http://127.0.0.1:${BACKEND_PORT}${HEALTH_PATH}"
          success=0
          for i in $(seq 1 ${START_TIMEOUT}); do
            if curl -fsS "http://127.0.0.1:${BACKEND_PORT}${HEALTH_PATH}" >/dev/null 2>&1; then
              echo "Backend is up (attempt $i)."
              success=1
              break
            fi
            sleep 1
          done

          if [ $success -ne 1 ]; then
            echo "Backend failed to start within ${START_TIMEOUT}s â€” dumping backend.log and diagnostics."
            echo "=== backend.log ==="
            if [ -f backend.log ]; then tail -n 400 backend.log || true; else echo "No backend.log found."; fi
            echo "=== ps output ==="
            ps aux | grep -E 'uvicorn|python|gunicorn|node' || true
            echo "=== ports ==="
            ss -lntp || netstat -lntp || true
            exit 1
          fi

      - name: Check backend process & logs
        run: |
          echo "PID file:"
          cat backend.pid || echo "no backend.pid"
          echo "=== tail backend.log ==="
          tail -n 200 backend.log || true
          echo "=== listening ports/processes ==="
          ps aux | grep -E 'uvicorn|python|gunicorn|node' || true
          ss -lntp || netstat -lntp || true

      # put any steps that require the running backend here (tests, integration, etc.)

      # - name: Stop backend (cleanup)
      #   if: always()
      #   run: |
      #     if [ -f backend.pid ]; then
      #       echo "Stopping backend (pid=$(cat backend.pid))"
      #       kill -TERM "$(cat backend.pid)" || true
      #       sleep 1
      #       rm -f backend.pid
      #     else
      #       echo "No backend.pid found; trying best-effort pkill"
      #       pkill -f "uvicorn backend.main:app" || true
      #       pkill -f "python backend/main.py" || true
      #     fi
      #     echo "=== final backend.log (tail) ==="
      #     tail -n 200 backend.log || true
