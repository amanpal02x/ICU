name: Build -> ECR -> Deploy (SSM)

# Trigger on push to main (change branch if needed)
on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: "601559288497"
  ECR_REPO: "icu-backend"
  SSM_INSTANCE_ID: "i-0d2d46164fecbb5c1"
  DEPLOY_SCRIPT_PATH: "/opt/myapp/deploy_from_ecr.sh"
  DEPLOY_S3_BUCKET: "icu-monitor-deploy-scripts"

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set IMAGE_TAG (short SHA)
        id: vars
        run: |
          echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure ECR repository exists
        run: |
          if ! aws ecr describe-repositories --repository-names "${{ env.ECR_REPO }}" >/dev/null 2>&1; then
            aws ecr create-repository --repository-name "${{ env.ECR_REPO }}" --region "${{ env.AWS_REGION }}"
            echo "Created ECR repository: ${{ env.ECR_REPO }}"
          else
            echo "ECR repository ${ECR_REPO} already exists"
          fi

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

      - name: Build Docker image (backend folder)
        run: |
          cd backend
          docker build -t ${{ env.ECR_REPO }}:${{ steps.vars.outputs.IMAGE_TAG }} .
          docker tag ${{ env.ECR_REPO }}:${{ steps.vars.outputs.IMAGE_TAG }} ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ steps.vars.outputs.IMAGE_TAG }}

      - name: Push image to ECR
        run: |
          docker push ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ steps.vars.outputs.IMAGE_TAG }}

      - name: Trigger deploy on EC2 via SSM (run deploy script with tag)
        id: ssm
        run: |
          IMAGE_TAG=${{ steps.vars.outputs.IMAGE_TAG }}
          echo "Sending SSM command to instance: ${{ env.SSM_INSTANCE_ID }} to run ${DEPLOY_SCRIPT_PATH} ${IMAGE_TAG}"
          aws ssm send-command \
            --region ${{ env.AWS_REGION }} \
            --instance-ids "${{ env.SSM_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy image ${IMAGE_TAG}" \
            --parameters commands=["sudo ${DEPLOY_SCRIPT_PATH} ${IMAGE_TAG}"] \
            --timeout-seconds 600 \
            --output json > /tmp/ssm_resp.json
          cat /tmp/ssm_resp.json
          CMD_ID=$(jq -r '.Command.CommandId' /tmp/ssm_resp.json)
          echo "SSM CommandId=$CMD_ID"
          echo "cmd_id=$CMD_ID" >> $GITHUB_OUTPUT

      - name: Wait for SSM command completion (poll)
        run: |
          CMD_ID="${{ steps.ssm.outputs.cmd_id }}"
          INSTANCE="${{ env.SSM_INSTANCE_ID }}"
          REGION="${{ env.AWS_REGION }}"
          echo "Polling for SSM command ${CMD_ID} status..."
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$INSTANCE" --region "$REGION" --query 'Status' --output text 2>/dev/null || echo "Pending")
            echo "Attempt $i - status: $STATUS"
            if [[ "$STATUS" == "Success" ]]; then
              echo "SSM command succeeded"
              exit 0
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              echo "SSM command ended with status: $STATUS"
              aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$INSTANCE" --region "$REGION" --output json
              exit 1
            fi
            sleep 5
          done
          echo "SSM command did not complete within timeout"
          exit 1
      - name: Success notice
        if: success()
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.IMAGE_TAG }}
        run: |
          echo "Image pushed and deploy triggered successfully: $IMAGE_TAG"
