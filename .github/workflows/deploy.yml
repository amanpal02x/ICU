name: Deploy ICU Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout latest code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ SSH to EC2 and deploy backend
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            cd /opt/app/ICU

            echo "üîÑ Pulling latest code..."
            git reset --hard
            git clean -fd
            git fetch origin main
            git checkout main
            git pull origin main

            echo "üì¶ Creating/updating virtual environment..."
            if [ ! -d "venv" ]; then
                python3 -m venv venv
            fi

            echo "üì¶ Activating virtual environment and installing dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r backend/requirements.txt

            echo "üêû DEBUG: Checking S3 bucket variable"
            echo "S3_BUCKET_NAME = '${{ secrets.S3_BUCKET_NAME }}'"
            echo "AWS_REGION = '${{ secrets.AWS_REGION }}'"

            if [ -z "${{ secrets.S3_BUCKET_NAME }}" ]; then
              echo "‚ùå ERROR: S3_BUCKET_NAME secret is EMPTY!"
              exit 1
            fi

            echo "‚òÅÔ∏è Ensuring S3 bucket exists..."
            if aws s3 ls "s3://${{ secrets.S3_BUCKET_NAME }}" 2>&1 | grep -q 'NoSuchBucket'; then
                echo "üöÄ Creating S3 bucket..."
                aws s3 mb s3://${{ secrets.S3_BUCKET_NAME }} --region ${{ secrets.AWS_REGION }}
            else
                echo "‚òÅÔ∏è S3 bucket exists, proceeding..."
            fi

            echo "‚òÅÔ∏è Syncing models folder to S3..."
            aws s3 sync backend/models s3://${{ secrets.S3_BUCKET_NAME }}/models --delete

            echo "üîÑ Restarting ICU service..."
            sudo systemctl daemon-reload
            sudo systemctl enable icu
            sudo systemctl restart icu

      # 4Ô∏è‚É£ Update API Gateway
      - name: Update API Gateway
        run: |
          set -e
          API_ID="${{ secrets.ICU_API_ID }}"
          STAGE_NAME="prod"
          BACKEND_URL="http://${{ secrets.EC2_HOST }}:8000"

          CURRENT_TARGET=$(aws apigatewayv2 get-api --api-id "$API_ID" --query 'Target' --output text)

          if [ "$CURRENT_TARGET" != "$BACKEND_URL" ]; then
            echo "üîÑ Updating API Gateway target..."
            aws apigatewayv2 update-api \
              --api-id "$API_ID" \
              --target "$BACKEND_URL"

            aws apigatewayv2 update-stage \
              --api-id "$API_ID" \
              --stage-name "$STAGE_NAME" \
              --auto-deploy

            API_ENDPOINT="https://$(aws apigatewayv2 get-api --api-id $API_ID --query 'ApiEndpoint' --output text)/$STAGE_NAME/"
            echo "‚úÖ API Gateway updated! Endpoint: $API_ENDPOINT"
          else
            echo "‚úÖ Backend URL unchanged. Skipping API Gateway update."
          fi
