name: Deploy Backend Code and Model

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "backend/requirements.txt" # Optimization: usually handled by git pull
      - "backend/models/**"
      - ".github/workflows/update-backend.yml"

permissions:
  id-token: write
  contents: read

env:
  # General configuration matching Terraform variables
  AWS_REGION: us-east-2
  EC2_INSTANCE_TAG: icu-backend
  S3_BUCKET_NAME: icu-models
  APP_DIR: /opt/app/ICU
  BACKEND_SERVICE: fastapi

jobs:
  upload-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. Configure AWS Credentials (Uses OIDC to assume the role defined in main.tf)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          # --- CRITICAL CHANGE REQUIRED ---
          role-to-assume: arn:aws:iam::601559288497:role/GitHubActionsTerraformRole
          aws-region: ${{ env.AWS_REGION }}

      # 2. Upload Model to S3 (Model change deployment)
      - name: Upload model directory to S3
        run: |
          # FIX: Using the environment variable for S3 bucket name
          aws s3 cp backend/models/ s3://${{ env.S3_BUCKET_NAME }}/models/ --recursive || echo "s3 upload returned non-zero (check path / permissions)"
          echo "Model upload complete."

      # 3. Deploy/Update the EC2 Backend via SSM (Code change deployment)
      - name: Update EC2 Backend via SSM
        run: |
          echo "Finding running EC2 instance by tag: Name=${{ env.EC2_INSTANCE_TAG }}"

          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ env.EC2_INSTANCE_TAG }}" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)

          if [ -z "$INSTANCE_ID" ]; then
            echo "::error::Could not find a running EC2 instance with tag Name=${{ env.EC2_INSTANCE_TAG }}. Is the instance up and registered with SSM?"
            exit 1
          fi

          echo "Found instance: $INSTANCE_ID. Sending update command via SSM..."

          # This command script pulls code and restarts the service on the EC2 instance
          UPDATE_COMMAND=$(cat <<'EOF'
          echo "--- Starting Code Pull, Requirements Update, and Service Restart ---"

          # Navigate to app directory
          cd /opt/app/ICU || (echo "App directory not found." && exit 1)

          # Pull latest code and install requirements as the 'ubuntu' user
          sudo -u ubuntu git pull 
          sudo -u ubuntu /opt/app/ICU/venv/bin/pip install -r /opt/app/ICU/backend/requirements.txt
          # Restart the FastAPI service
          systemctl daemon-reload
          systemctl restart fastapi

          echo "--- Service Restart Triggered ---"
          EOF
          )

          # Send the command via SSM
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Update code and restart fastapi service" \
            --parameters commands="$UPDATE_COMMAND" \
            --output text

          echo "SSM command sent. Check AWS Systems Manager Run Command logs for status."
